---

layout: single  
title: "Redis高伸缩性"  
date: 2022-05-19 00:57:00 +0800   
categories: Redis Redis-Base

---

![切片集群架构图](/assets/img/切片集群架构图.jpg)

* 纵向扩展（scale up）：升级单个 Redis 实例的资源配置，包括增加内存容量、增加磁盘容量、使用更高配置的 CPU。
* 横向扩展（scale out）：增加当前集群Redis 实例的个数。
* 数据切片和实例的对应分布关系
	* 在 Redis Cluster 方案中，一个切片集群共有 16384 个哈希槽， cluster create 命令创建集群，此时，Redis 会自动把这些槽平均分布在集群实例上。也可以使用 cluster meet 命令手动建立实例间的连接，形成集群，再使用 cluster addslots 命令，指定每个实例上的哈希槽个数。在手动分配哈希槽时，需要把 16384 个槽都分配完，否则 Redis 集群无法正常工作。
	* Redis 实例会把自己的哈希槽信息发给和它相连接的其它实例，来完成哈希槽分配信息的扩散。
* 客户端和集群实例的连接
	* 建立连接后，实例就会把哈希槽的分配信息发给客户端，客户端缓存哈希槽的分配信息，再根据键值对计算得到哈希槽，最后获取哈希槽对应的实例进行请求发送。
	* 在集群中，实例有新增或删除，Redis 需要重新分配哈希槽；为了负载均衡，Redis 需要把哈希槽在所有实例上重新分布一遍。
	* 客户端是无法主动感知哈希槽的重新分配的，故Redis提供了一种重定向机制，当对应的键值对没有在实例上时，会返回（MOVED 哈希槽 新的实例地址）。客户端获取新的实例地址，重新请求并更新本地哈希槽与实例地址的缓存。
	* 如果哈希槽正在迁移，且要获取的键值对已经迁移过去了，则会返回（ASK 哈希槽 新的实例地址），之后客户端需要先向新的实例地址发送ASk命令后再发送操作命令。
	* 和 MOVED 命令不同，ASK 命令并不会更新客户端缓存的哈希槽分配信息。所以，在上图中，如果客户端再次请求 Slot 2 中的数据，它还是会给实例 2 发送请求。这也就是说，ASK 命令的作用只是让客户端能给新实例发送一次请求，而不像 MOVED 命令那样，会更改本地缓存，让后续所有命令都发往新实例。