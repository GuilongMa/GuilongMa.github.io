---

layout: single  
title: "Redis高可靠性"  
date: 2022-05-18 22:17:00 +0800   
categories: Redis Redis-Base

---

# 主-从模式与数据同步

* Redis 具有高可靠性有两层含义：一是数据尽量少丢失，二是服务尽量少中断。
* Redis 提供了主从库模式，以保证数据副本的一致，主从库之间采用的是读写分离的方式。
	
	![Redis主从库和读写分离](Redis主从库和读写分离.jpg)
	
* 主从库间如何进行第一次同步：
	
	![主从库第一次同步的流程](/assets/img/主从库第一次同步的流程.jpg)
	
	* runID，是每个 Redis 实例启动时都会自动生成的一个随机 ID，用来唯一标记这个实例。当从库和主库第一次复制时，因为不知道主库的 runID，所以将 runID 设为“？”。
	* offset，此时设为 -1，表示第一次复制。 	
	* FULLRESYNC 响应表示第一次复制采用的全量复制，也就是说，主库会把当前所有的数据都复制给从库。
	* 主库执行 bgsave 命令，生成 RDB 文件，接着将文件发给从库。
	* 为了保证主从库的数据一致性，主库会在内存中用专门的 replication buffer，记录 RDB 文件生成后收到的所有写操作。
* 主从级联模式分担全量复制时的主库压力：将主库生成 RDB 和传输 RDB 的压力，以级联的方式分散到从库上。
	
	![级联的“主-从-从”模式](/assets/img/级联的“主-从-从”模式.jpg)
	
* 主从库间网络断了，从库会采用增量复制的方式继续同步。
	* repl_backlog_buffer 是一个环形缓冲区，主库会记录自己写到的位置，从库则会记录自己已经读到的位置。

	![Redis增量复制流程](/assets/img/Redis增量复制流程.jpg)
	
	* 如果从库的读取速度比较慢，就有可能导致从库还未读取的操作被主库新写的操作覆盖了，这会导致主从库间的数据不一致。调整 repl_backlog_size 这个参数。这个参数和所需的缓冲空间大小有关。缓冲空间的计算公式是：缓冲空间大小 = 主库写入命令速度 * 操作大小 - 主从库间网络传输命令速度 * 操作大小。在实际应用中，考虑到可能存在一些突发的请求压力，我们通常需要把这个缓冲空间扩大一倍，即 repl_backlog_size = 缓冲空间大小 * 2，这也就是 repl_backlog_size 的最终值 。

# 哨兵机制

* 主库真的挂了吗？=》该选择哪个从库作为主库？=〉怎么把新主库的相关信息通知给从库和客户端呢？
* 哨兵主要负责的就是三个任务：监控、选主（选择主库）和通知。
	* 监控：所有实例发送PING，没有响应的实例标记为下线，没有响应的主库则需要进行从库到主库的切换。
	* 选主：
		* 主观下线：一个哨兵获取不到PING主库的响应；
		* 客观下线：哨兵集群中多个哨兵同时获取不到PING主库的响应，即多个主观下线，且主观下线大于总哨兵集群数的一半，即至少N/2+1；
		* 先按照**一定的筛选条件**，把不符合条件的从库去掉。然后，我们再按照**一定的规则**，给剩下的从库逐个**打分**，将得分最高的从库选为新主库。
			* 筛选：主从库断连的最大连接超时时间down-after-milliseconds 毫秒，如果发生断连的次数超过了 10 次，就说明这个从库的网络状况不好，不适合作为新主库。 
			* 打分：
				* 优先级最高的从库得分高，优先级通过配置项slave-priority设置。
				* 和旧主库同步程度最接近的从库得分高：slave_repl_offset值最接近master_repl_offset的那个从库
				* 默认在优先级和复制进度都相同的情况下，ID 号最小的从库得分最高，会被选为新主库。 
	* 通知：哨兵会把新主库的连接信息发给其他从库，让它们执行 replicaof 命令，和新主库建立连接，并进行数据复制。同时，哨兵会把新主库的连接信息通知给客户端，让它们把请求操作发到新主库上。

* 哨兵集群：
	* 配置哨兵集群：sentinel monitor <master-name> <ip> <redis-port> <quorum>  
	* 基于 pub/sub 机制的哨兵集群组成：
		* 多个哨兵只有订阅了同一个频道的，才能通过发布的消息（比如连接信息：IP和端口）进行信息交换。 
		* 在主从集群中，主库上有一个名为“__sentinel__:hello”的频道，不同哨兵就是通过它来相互发现，实现互相通信的 		
		*  哨兵向主库发送 INFO 命令来获取从库列表，从而知道从库的 IP 地址和端口。
	* 基于 pub/sub 机制的客户端事件通知：
		* 从本质上说，哨兵就是一个运行在特定模式下的 Redis 实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。。所以，每个哨兵实例也提供 pub/sub 机制，客户端可以从哨兵订阅消息。哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件。
	* 执行主从切换的哨兵：
		1.  任何一个哨兵实例只要自身判断主库“主观下线”后，就会给其他实例发送 is-master-down-by-addr 命令。
		2. 第一步中如果有多个哨兵都判断出客观下线（即 is-master-down-by-addr的响应个数大于 quorum 配置项）后，接下来进行哨兵leader选举
		3. 哨兵leader选举：想成为leader的哨兵都发送选举命令以获取赞成票，拿到半数以上的赞成票且拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值的哨兵就成为leader。如果所有哨兵票数相同，那么这轮投票就不会产生 Leader。哨兵集群会等待一段时间（也就是哨兵故障转移超时时间的 2 倍），再重新选举。
		4. **注意**：如果哨兵集群只有 2 个实例，此时，一个哨兵要想成为 Leader，必须获得 2 票，而不是 1 票。所以，如果有个哨兵挂掉了，那么，此时的集群是无法进行主从库切换的。因此，通常我们至少会配置 3 个哨兵实例。
		5. 要保证所有哨兵实例的配置是一致的，尤其是主观下线的判断值 down-after-milliseconds。
			