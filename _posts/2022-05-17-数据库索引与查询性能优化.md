---

layout: single  
title: "数据库索引与查询性能优化"  
date: 2022-05-17 20:17:00 +0800   
categories: Mysql Mysql-Base

---

# 索引

* 哈希索引：做区间查询的速度是很慢的。故哈希表这种结构适用于只有等值查询的场景。比如 Memcached 及其他一些 NoSQL 引擎。
* 有序数组在等值查询和范围查询场景中的性能就都非常优秀。有序数组索引只适用于静态存储引擎。
* InnoDB 的索引模型：
	* 在 InnoDB 中，表都是根据主键顺序以索引的形式存放的，这种存储方式的表称为索引组织表。又因为前面我们提到的，InnoDB 使用了 B+ 树索引模型，所以数据都是存储在 B+ 树中的。
	* 每一个索引在 InnoDB 里面对应一棵 B+ 树。
	* 主键索引：叶子节点存储完整的数据记录。
	* 非主键索引：叶子节点存储主键值。
	* 非主键索引的叶子节点内容是主键的值。在 InnoDB 里，非主键索引也被称为二级索引（secondary index）。
	* 回表：先检索非主键索引树，再将检索到的值去检索主键索引树。故基于非主键索引的查询需要多扫描一棵索引树。因此，我们在应用中应该尽量使用主键查询。
	* 索引维护：页分裂，页合并，页旋转。
	* 主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小。
* 索引优化：
	* 覆盖索引：由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段。避免了回表，即主键值即为查询结果。
	* 联合索引：（a，b）为联合索引的元素形式，则得到a的检索结果后直接可以获取到b。
	* 最左前缀原则：B+ 树这种索引结构，可以利用索引的“最左前缀”，来定位记录。最左前缀可以是联合索引的最左 N 个字段，也可以是字符串索引的最左 M 个字符。
	* 索引下推：可以在索引遍历过程中，对索引中包含的字段（比如联合索引的其他字段）先做判断，直接过滤掉不满足条件的记录，减少回表次数。
	* 哈希索引：InnoDB 存储引擎有一个特殊的功能叫“自适应哈希索引”，当某个索引值被使用的非常频繁时，会在 B+Tree 索引之上再创建一个哈希索引，这样就让 B+Tree 索引具有哈希索引的一些优点，比如快速的哈希查找。
* 索引的优点：
	* 将随机 I/O 变为顺序 I/O（B+Tree 索引是有序的，会将相邻的数据都存储在一起）
	* 大大减少了服务器需要扫描的数据行数。
	* 帮助服务器避免进行排序和分组，以及避免创建临时表（B+Tree 索引是有序的，可以用于 ORDER BY 和 GROUP BY 操作。临时表主要是在排序和分组过程中创建，不需要排序和分组，也就不需要创建临时表）。

# 查询性能优化

* Explain 用来分析 SELECT 查询语句，开发人员可以通过分析 Explain 结果来优化查询语句。
	* 	比较重要的字段有：
	* 	select_type : 查询类型，有简单查询、联合查询、子查询等
	* 	key : 使用的索引
	* 	rows : 扫描的行数
* 减少请求的数据量
	* 只返回必要的列：最好不要使用 SELECT * 语句。
	* 只返回必要的行：使用 LIMIT 语句来限制返回的数据。
	* 缓存重复查询的数据：使用缓存可以避免在数据库中进行查询，特别在要查询的数据经常被重复查询时，缓存带来的查询性能提升将会是非常明显的。 
* 减少服务器端扫描的行数：加索引。
* 重构查询：
	* 切分大查询
	* 分解大连接查询 