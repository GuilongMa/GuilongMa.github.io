---

layout: single  
title: "Redis数据类型与底层数据结构"  
date: 2022-05-18 12:17:00 +0800   
categories: Redis Redis-Base

---

* Redis数据类型：String（字符串）、List（列表）、Hash（哈希）、Set（集合）和 Sorted Set（有序集合）
* 从键到值的快速访问，Redis 使用了一个哈希表来保存所有键值对。哈希桶中的 entry 元素中保存了`*key和*value`指针，分别指向了实际的键和值。如下图：
	
	![键值对哈希表](/assets/img/键值对哈希表.jpg)
	
* Redis 会对哈希表做 rehash 操作(渐进式 rehash)。rehash 也就是增加现有的哈希桶数量，让逐渐增多的 entry 元素能在更多的桶之间分散保存，减少单个桶中的元素数量，从而减少单个桶中的冲突。
* 为了使 rehash 操作更高效，Redis 默认使用了两个全局哈希表：哈希表 1 和哈希表 2。一开始，当你刚插入数据时，默认使用哈希表 1，此时的哈希表 2 并没有被分配空间。随着数据逐步增多，Redis 开始执行 rehash，这个过程分为三步：
	* 给哈希表 2 分配更大的空间，例如是当前哈希表 1 大小的两倍；
	* 把哈希表 1 中的数据重新映射并拷贝到哈希表 2 中；
	* 释放哈希表 1 的空间。
* 渐进式 rehash：每次对请求将检索到的索引位置上的所有 entries顺带 拷贝到新的哈希表，这样将一次性大量拷贝的开销，分摊到了多次处理请求的过程中，避免了耗时操作，保证了数据的快速访问。
* Redis底层数据结构：一共有 6 种，分别是简单动态字符串、双向链表、压缩列表、哈希表、跳表和整数数组。
	
	![redis数据类型的底层数据结构](/assets/img/redis数据类型的底层数据结构.jpg)
	**注意**：上图中的多个箭头代表多种不同实现。

	* 简单动态字符串（SDS）：结构体字段：buf未使用的字节数（free）， （已使用的字节数，即字符串长度，不包括结尾空字符）len， buf（字节数组）。 
	* 双向链表：时间复杂度O（n）；持有链表（不同于链表节点）结构体字段：表头节点，表尾节点，节点数量等。可用于实现列表键。
	* 压缩列表：时间复杂度O（n），可用于实现列表键，哈希键，有序集合（少量元素，且元素值为短字符串或者小整数值）。
	* 哈希表：时间复杂度O（1），结构体字段：哈希表数组（哈希桶），哈希表大小，节点数量等。
	* 跳表：时间复杂度O（logn），可用于实现有序集合。
	* 整数数组：时间复杂度O（n），可用于只包含整数值的集合键，比如Set集合。结构体字段：编码方式，元素数量，元素数组（元素类型取决于编码方式）。

* 压缩列表：
	* 压缩列表在表头有三个字段 zlbytes、zltail 和 zllen，分别表示压缩列表长度、列表尾（即zlend的前面一个entry）的偏移量和列表中的 entry 个数；压缩列表在表尾还有一个 zlend，表示列表结束。 
	* entry节点可以是字节数组或者一个整数值。
	* entry包括：前一节点的长度，encoding（节点content属性的数据类型和长度），content。
	* 添加和删除新节点可能带来连锁更新，概率很低。

* 跳表：跳表在链表的基础上，增加了多级索引，通过索引位置的几个跳转，实现数据的快速定位。
	
	![跳表数据查找](/assets/img/跳表数据查找.jpg)
	
	* 持有跳跃表结构体字段：header（表头节点），tail，level（层数最大的节点的层数，不包括表头节点），length（节点个数）
	* 节点结构体字段：后退指针，分值，成员对象，层（数组，每个元素是包含前进指针，跨度的结构体）
	
